<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pci.onbid.mapper.OnbidMapper">

    <!-- ✅ 전체 조회 -->
    <select id="findAll" resultType="OnbidItem">
        SELECT
        id,
        plnm_no AS plnmNo,
        cltr_mnmt_no AS cltrMnmtNo,
        cltr_hstr_no AS cltrHstrNo,
        cltr_nm AS cltrNm,
        ldnm_adrs AS ldnmAdrs,
        min_bid_prc AS minBidPrc,
        apsl_ases_avg_amt AS apslAsesAvgAmt,
        pbct_begn_dtm AS pbctBegnDtm,
        pbct_cls_dtm AS pbctClsDtm,
        pbct_cltr_stat_nm AS pbctCltrStatNm,
        sido,
        created_at AS createdAt
        FROM onbid_item
        ORDER BY id DESC
    </select>

    <!-- ⭐ 단일 삽입 (주소+이력번호 중복 방지) -->
    <insert id="insert"
            parameterType="OnbidItem"
            useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO onbid_item
        (plnm_no, cltr_mnmt_no, cltr_hstr_no, cltr_nm, ldnm_adrs,
        min_bid_prc, apsl_ases_avg_amt, pbct_begn_dtm, pbct_cls_dtm,
        pbct_cltr_stat_nm, sido)
        SELECT
        #{plnmNo}, #{cltrMnmtNo}, #{cltrHstrNo}, #{cltrNm}, #{ldnmAdrs},
        #{minBidPrc}, #{apslAsesAvgAmt}, #{pbctBegnDtm}, #{pbctClsDtm},
        #{pbctCltrStatNm}, #{sido}
        WHERE NOT EXISTS (
            SELECT 1 FROM onbid_item
            WHERE ldnm_adrs = #{ldnmAdrs} AND cltr_hstr_no = #{cltrHstrNo}
        )
    </insert>

    <!-- ✅ 검색 기능 -->
    <select id="searchAdvanced" resultType="OnbidItem">
        SELECT
        id,
        plnm_no AS plnmNo,
        cltr_mnmt_no AS cltrMnmtNo,
        cltr_nm AS cltrNm,
        ldnm_adrs AS ldnmAdrs,
        min_bid_prc AS minBidPrc,
        apsl_ases_avg_amt AS apslAsesAvgAmt,
        pbct_begn_dtm AS pbctBegnDtm,
        pbct_cls_dtm AS pbctClsDtm,
        pbct_cltr_stat_nm AS pbctCltrStatNm,
        sido,
        created_at AS createdAt
        FROM onbid_item
        WHERE 1=1
        <if test="region != null and region != ''">
            AND sido LIKE CONCAT('%', #{region}, '%')
        </if>
        <if test="category != null and category != ''">
            AND cltr_nm LIKE CONCAT('%', #{category}, '%')
        </if>
        <if test="status != null and status != ''">
            AND pbct_cltr_stat_nm LIKE CONCAT('%', #{status}, '%')
        </if>
        <if test="minPrice != null">
            AND CAST(min_bid_prc AS UNSIGNED) >= #{minPrice}
        </if>
        <if test="maxPrice != null">
            AND CAST(min_bid_prc AS UNSIGNED) &lt;= #{maxPrice}
        </if>
        <if test="plnmNo != null and plnmNo != ''">
            AND plnm_no LIKE CONCAT('%', #{plnmNo}, '%')
        </if>
        ORDER BY id DESC
    </select>

    <!-- ✅ DTO 기반 검색 -->
    <select id="searchByCriteria" parameterType="SearchCriteria" resultType="OnbidItem">
        SELECT
            id,
            plnm_no AS plnmNo,
            cltr_mnmt_no AS cltrMnmtNo,
            cltr_nm AS cltrNm,
            ldnm_adrs AS ldnmAdrs,
            min_bid_prc AS minBidPrc,
            apsl_ases_avg_amt AS apslAsesAvgAmt,
            pbct_begn_dtm AS pbctBegnDtm,
            pbct_cls_dtm AS pbctClsDtm,
            pbct_cltr_stat_nm AS pbctCltrStatNm,
            sido,
            created_at AS createdAt
        FROM onbid_item
        WHERE 1=1
        <if test="region != null and region != ''">
            AND sido LIKE CONCAT('%', #{region}, '%')
        </if>
        <if test="category != null and category != ''">
            AND cltr_nm LIKE CONCAT('%', #{category}, '%')
        </if>
        <if test="status != null and status != ''">
            AND pbct_cltr_stat_nm LIKE CONCAT('%', #{status}, '%')
        </if>
        <if test="minPrice != null">
            AND CAST(min_bid_prc AS UNSIGNED) >= #{minPrice}
        </if>
        <if test="maxPrice != null">
            AND CAST(min_bid_prc AS UNSIGNED) &lt;= #{maxPrice}
        </if>
        <if test="plnmNo != null and plnmNo != ''">
            AND plnm_no LIKE CONCAT('%', #{plnmNo}, '%')
        </if>
        ORDER BY id DESC
    </select>

    <!-- ✅ 주소 기준 그룹 조회 -->
    <select id="selectGroupedByAddress" resultType="AddressGroupedDto">
        SELECT
        TRIM(
        REGEXP_REPLACE(
        REGEXP_REPLACE(ldnm_adrs, '\\[.*?\\]', ''),
        '\\(.*?\\)', ''
        )
        ) AS address,
        COUNT(*) AS count
        FROM onbid_item
        WHERE ldnm_adrs IS NOT NULL AND ldnm_adrs != ''
        <if test="q != null and q != ''">
            AND ldnm_adrs LIKE CONCAT('%', #{q}, '%')
        </if>
        GROUP BY address
        ORDER BY count DESC, address ASC
        LIMIT #{size} OFFSET #{offset}
    </select>

</mapper>
