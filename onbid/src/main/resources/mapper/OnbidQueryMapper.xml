<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pci.onbid.mapper.OnbidQueryMapper">

    <!-- 이력 저장 (중복 방지) -->
    <insert id="insertHistoryIfNotExists">
        INSERT IGNORE INTO onbid_history (
            item_id,
            normalized_address,
            created_at
        )
        SELECT 
            #{itemId},
            TRIM(
                REGEXP_REPLACE(
                    REGEXP_REPLACE(oi.ldnm_adrs, '\\[.*?\\]', ''),
                    '\\(.*?\\)', ''
                )
            ),
            NOW()
        FROM onbid_item oi
        WHERE oi.id = #{itemId}
    </insert>

    <!-- 주소별 그룹 조회 -->
    <select id="selectGroupedByAddress" resultType="com.pci.onbid.domain.AddressGroupedDto">
        SELECT
            TRIM(
                REGEXP_REPLACE(
                    REGEXP_REPLACE(ldnm_adrs, '\\[.*?\\]', ''),
                    '\\(.*?\\)', ''
                )
            ) AS address,
            COUNT(*) AS count
        FROM onbid_item
        WHERE ldnm_adrs IS NOT NULL AND ldnm_adrs != ''
        <if test="q != null and q != ''">
            AND ldnm_adrs LIKE CONCAT('%', #{q}, '%')
        </if>
        GROUP BY address
        ORDER BY count DESC, address ASC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 주소별 그룹 총 개수 -->
    <select id="countGroupedByAddress" resultType="int">
        SELECT COUNT(DISTINCT 
            TRIM(
                REGEXP_REPLACE(
                    REGEXP_REPLACE(ldnm_adrs, '\\[.*?\\]', ''),
                    '\\(.*?\\)', ''
                )
            )
        )
        FROM onbid_item
        WHERE ldnm_adrs IS NOT NULL AND ldnm_adrs != ''
        <if test="q != null and q != ''">
            AND ldnm_adrs LIKE CONCAT('%', #{q}, '%')
        </if>
    </select>

    <!-- 주소별 이력 조회 -->
    <select id="selectHistoryByAddress" resultType="com.pci.onbid.domain.HistoryDto">
        SELECT
            h.id,
            h.item_id AS itemId,
            h.normalized_address AS address,
            h.created_at AS createdAt
        FROM onbid_history h
        WHERE h.normalized_address = #{address}
        ORDER BY h.created_at DESC
    </select>

</mapper>