<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pci.onbid.mapper.OnbidQueryMapper">

    <!-- ðŸŸ¡ ì´ë ¥ ì €ìž¥: onbid_item ì •ë³´ ê·¸ëŒ€ë¡œ ì €ìž¥ / ì¤‘ë³µì €ìž¥ ë°©ì§€ -->
    <insert id="insertHistoryIfNotExists">
        INSERT IGNORE INTO onbid_history(
        item_id,
        cltr_hstr_no,
        cltr_no,
        pbct_begn_dtm,
        pbct_cls_dtm,
        open_price,
        cltr_stts_nm,
        created_at
        )
        SELECT
        id,
        cltr_hstr_no,
        plnm_no,
        pbct_begn_dtm,
        pbct_cls_dtm,
        min_bid_prc,
        pbct_cltr_stat_nm,
        NOW()
        FROM onbid_item
        WHERE id = #{itemId}
    </insert>

    <!-- ðŸŸ¢ ì£¼ì†Œë³„ grouped ì¡°íšŒ -->
    <select id="selectGroupedByAddress" resultType="AddressGroupedDto">
        SELECT
        TRIM(ldnm_adrs) AS address,
        COUNT(*) AS count
        FROM onbid_item
        WHERE ldnm_adrs != ''
        GROUP BY ldnm_adrs
        ORDER BY count DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- ðŸ” ì£¼ì†Œë³„ ì´ë ¥ ì¡°íšŒ -->
    <select id="selectHistoryByAddress" resultType="HistoryDto">
        SELECT
        cltr_hstr_no AS cltrHstrNo,
        cltr_no AS cltrNo,
        pbct_begn_dtm AS pbctBegnDtm,
        pbct_cls_dtm AS pbctClsDtm,
        open_price AS openPrice,
        cltr_stts_nm AS cltrSttsNm,
        created_at AS createdAt
        FROM onbid_history
        WHERE item_id IN (
        SELECT id FROM onbid_item
        WHERE ldnm_adrs LIKE CONCAT('%', #{address}, '%')
        )
        ORDER BY created_at DESC
    </select>

</mapper>
